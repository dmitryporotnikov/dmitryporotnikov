<!doctype html><html lang=en-us dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="@description(&lsquo;Size of VMs in the VM Scale Set.&rsquo;) param vmSku string = &lsquo;Standard_B2ms&rsquo;
@description(&lsquo;The Windows version for the VM. This will pick a fully patched image of this given Windows version. Allowed values: 2008-R2-SP1, 2012-Datacenter, 2012-R2-Datacenter & 2016-Datacenter, 2019-Datacenter.&rsquo;) @allowed([ &lsquo;2008-R2-SP1&rsquo; &lsquo;2012-Datacenter&rsquo; &lsquo;2012-R2-Datacenter&rsquo; &lsquo;2016-Datacenter&rsquo; &lsquo;2019-Datacenter&rsquo; ]) param windowsOSVersion string = &lsquo;2019-Datacenter&rsquo;
@description(&lsquo;Number of VM instances (100 or less).&rsquo;) @minValue(1) @maxValue(100) param instanceCount int = 3
@description(&lsquo;When true this limits the scale set to a single placement group, of max size 100 virtual machines."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="http://localhost:1313/docs/legacy/2023-08-23-bicep-deploy-virtual-machine-scale-set-and-put-it-behind-ilb-internal-load-balancer-as-backend-pool/"><meta property="og:site_name" content="My New Hugo Site"><meta property="og:title" content="Bicep: Deploy Virtual Machine Scale Set and put it behind ILB (Internal Load Balancer) as backend pool"><meta property="og:description" content="@description(‘Size of VMs in the VM Scale Set.’) param vmSku string = ‘Standard_B2ms’
@description(‘The Windows version for the VM. This will pick a fully patched image of this given Windows version. Allowed values: 2008-R2-SP1, 2012-Datacenter, 2012-R2-Datacenter & 2016-Datacenter, 2019-Datacenter.’) @allowed([ ‘2008-R2-SP1’ ‘2012-Datacenter’ ‘2012-R2-Datacenter’ ‘2016-Datacenter’ ‘2019-Datacenter’ ]) param windowsOSVersion string = ‘2019-Datacenter’
@description(‘Number of VM instances (100 or less).’) @minValue(1) @maxValue(100) param instanceCount int = 3
@description(‘When true this limits the scale set to a single placement group, of max size 100 virtual machines."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2023-08-23T10:09:30+00:00"><meta property="article:modified_time" content="2023-08-23T10:09:30+00:00"><title>Bicep: Deploy Virtual Machine Scale Set and put it behind ILB (Internal Load Balancer) as backend pool | My New Hugo Site</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=canonical href=http://localhost:1313/docs/legacy/2023-08-23-bicep-deploy-virtual-machine-scale-set-and-put-it-behind-ilb-internal-load-balancer-as-backend-pool/><link rel=stylesheet href=/book.min.309b7ed028807cdb68d8d61e26d609f48369c098dbf5e4d8c0dcf4cdf49feafc.css integrity="sha256-MJt+0CiAfNto2NYeJtYJ9INpwJjb9eTYwNz0zfSf6vw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.13c65bda707baac5f46972efbbbbbde1ee6aeae6ddbc296414565b945d573372.js integrity="sha256-E8Zb2nB7qsX0aXLvu7u94e5q6ubdvClkFFZblF1XM3I=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>My New Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><a href=/docs/example/>Example Site</a><ul><li><a href=/docs/example/table-of-contents/>Table of Contents</a><ul><li><a href=/docs/example/table-of-contents/with-toc/>With ToC</a></li><li><a href=/docs/example/table-of-contents/without-toc/>Without ToC</a></li></ul></li><li><input type=checkbox id=section-3049b9efa63db187c30edc63a05cabc2 class=toggle>
<label for=section-3049b9efa63db187c30edc63a05cabc2 class="flex justify-between"><a role=button>Collapsed</a></label><ul><li><a href=/docs/example/collapsed/3rd-level/>3rd Level</a><ul><li><a href=/docs/example/collapsed/3rd-level/4th-level/>4th Level</a></li></ul></li></ul></li></ul></li><li class=book-section-flat><a href=/docs/example2/>Example Site</a><ul><li><a href=/docs/example2/table-of-contents/>Table of Contents</a><ul><li><a href=/docs/example2/table-of-contents/with-toc/>With ToC</a></li><li><a href=/docs/example2/table-of-contents/without-toc/>Without ToC</a></li></ul></li><li><input type=checkbox id=section-241c84bb3eab034a2a9fc6034c481dd5 class=toggle>
<label for=section-241c84bb3eab034a2a9fc6034c481dd5 class="flex justify-between"><a role=button>Collapsed</a></label><ul><li><a href=/docs/example2/collapsed/3rd-level/>3rd Level</a><ul><li><a href=/docs/example2/collapsed/3rd-level/4th-level/>4th Level</a></li></ul></li></ul></li></ul></li><li><a href=/docs/legacy/2024-06-10-azure-linux-vm-time-synchronization/>Setting Up Chrony for Time Synchronization in Azure VMs</a></li><li><a href=/docs/legacy/2024-05-23-p-vs-np-the-biggest-puzzle-in-computer-science/>P vs. NP: The Biggest Puzzle in Computer Science</a></li><li><a href=/docs/legacy/2024-04-23-resolving-argument-list-too-long-error-linux/>Resolving the &amp;#8220;Argument list too long&amp;#8221; Error When Deleting Files in Linux</a></li><li><a href=/docs/legacy/2024-03-28-automatic-os-upgrade-vmss-issue/>Automatic OS Upgrade is not supported for this Virtual Machine Scale Set because a health probe or health extension was not specified.</a></li><li><a href=/docs/legacy/2024-03-27-one-liner-to-add-new-privileged-user-to-azure-linux-vm-using-run-command/>One-liner to add new privileged user to Azure Linux VM using run command</a></li><li><a href=/docs/legacy/2024-03-21-tracing-cron-jobs/>Troubleshooting a Non-Working Linux Cron Job with Strace</a></li><li><a href=/docs/legacy/2024-03-17-revitalize-dell-latitude-e5570-arch-linux/>Adventures with Arch Linux on an Old Laptop &amp;#8211; Dell Latitude E5570</a></li><li><a href=/docs/legacy/2024-02-11-windows-filtering-platform-wfp-overview/>Had some fun today learning about WFP drivers</a></li><li><a href=/docs/legacy/2024-02-09-kql-query-microsoft-services-retirement/>List services scheduled for retirement in Azure Graph / KQL</a></li><li><a href=/docs/legacy/2024-02-02-azure-vm-deployment-azure-ad-issue/>Encountering issues with Azure IAAS Virtual Machines not joining Azure AD post-deployment from a sysprepped template?</a></li><li><a href=/docs/legacy/2024-02-01-create-custom-filter-driver-windows/>How to Create Your Own Custom Filter Driver for Windows</a></li><li><a href=/docs/legacy/2024-01-30-install-windbg-windows-server-no-windows-store/>How to install WinDBG preview (Windows Store version) on Windows Server?</a></li><li><a href=/docs/legacy/2024-01-15-azzure-resource-graph-query-access/>Azure Resource Graph Queries to see who has access to Azure Subscriptions</a></li><li><a href=/docs/legacy/2023-12-01-recover-azure-vm-domain-admin-access/>PowerShell: Create a New Domain Admin User</a></li><li><a href=/docs/legacy/2023-11-07-enable-anonymous-access-azure-blob-storage/>Enabling Anonymous Access to Azure Blob Storage</a></li><li><a href=/docs/legacy/2023-11-06-manage-smb-1-windows/>Current configuration options for SMB 1.0 in Windows Environments</a></li><li><a href=/docs/legacy/2023-10-18-setting-up-a-flask-web-application-with-gunicorn-on-wsl/>Setting Up a Flask Web Application with Gunicorn on WSL</a></li><li><a href=/docs/legacy/2023-10-15-most-popular-operating-systems-desktop-laptops-1978-2023/>Most Popular Operating Systems (Desktop &amp;amp; Laptops) 1978 &amp;#8211; 2023</a></li><li><a href=/docs/legacy/2023-10-12-azure-vm-log-analysis-powershell/>PowerShell: Analyzing Virtual Machine Activity Logs to Determine Uptime and Downtime</a></li><li><a href=/docs/legacy/2023-10-11-thank-you-chatgpt/>Thank You, ChatGPT</a></li><li><a href=/docs/legacy/2023-10-11-nested-virtualization-madness-running-dosbox-inside-windows-xp-inside-windows-10-on-an-azure-vm-with-hyper-v/>Nested Virtualization Madness: Running DOSBox Inside Windows XP Inside Windows 10 on an Azure VM with Hyper-V</a></li><li><a href=/docs/legacy/2023-10-10-bypassing-azure-vm-limitations-script-based-solution/>PowerShell: Script-Based Workaround for Renaming Azure VMs and Switching to Unsupported Sizes</a></li><li><a href=/docs/legacy/2023-10-08-understanding-azure-capacity-reservations-guide/>Azure Capacity Reservations &amp;#038; Azure Reserved Instances</a></li><li><a href=/docs/legacy/2023-10-08-deploy-3-rhel-9_2-vms-with-shared-disks-to-form-a-cluster/>Bicep: Deploy 3 RHEL 9.2 VMs with shared disks to form a cluster</a></li><li><a href=/docs/legacy/2023-10-05-detecting-hypervisor-presence-using-cpuid-in-cpp/>C++: Detecting Hypervisor Presence Using CPUID Timing</a></li><li><a href=/docs/legacy/2023-10-03-linux-aio-performance-checker-real-time-diagnostics/>Streamlining Linux System Diagnostics: An Open-Source, Web-Based Approach</a></li><li><a href=/docs/legacy/2023-10-01-reverse-engineering-dotnet-applications-without-assembler/>Reverse Engineering .NET Applications Without Using Assembler</a></li><li><a href=/docs/legacy/2023-09-28-azure-rest-api-powershell-poc/>Rest API: Azure REST API POC</a></li><li><a href=/docs/legacy/2023-09-27-how-to-upgrade-legacy-azure-windows-vms/>How to Upgrade Legacy Azure Windows VMs Not Supported by Azure&amp;#8217;s Native In-Place Upgrade Feature</a></li><li><a href=/docs/legacy/2023-09-25-deploy-storage-spaces-on-azure-vm/>Deploy Storage Spaces on a Single Virtual Machine to Get Optimal Performance/Cost Ratio</a></li><li><a href=/docs/legacy/2023-09-24-windows-server-azure-vm-in-place-upgrade/>In Place Upgrade Your Windows Server Azure VM: Step by Step Guide</a></li><li><a href=/docs/legacy/2023-09-22-how-to-resolve-the-nla-error-in-azure-vms-when-the-computer-object-is-removed-from-active-directory/>How to resolve the NLA error in Azure VMs when the computer object is removed from Active Directory</a></li><li><a href=/docs/legacy/2023-09-22-simulating-memory-leaks-in-c-with-the-c-memory-leaker-tool-veryleakycauldron/>C++: Memory Leaker Tool &amp;#8211; VeryLeakyCauldron</a></li><li><a href=/docs/legacy/2023-09-21-why-cant-i-resize-the-underlying-storage-used-by-storage-spaces-direct/>Why can&amp;#8217;t I resize the underlying storage used by Storage Spaces?</a></li><li><a href=/docs/legacy/2023-09-20-powershell-download-and-use-azcopy-to-upload-files-to-azure-blob-storage/>PowerShell: Download and Use AzCopy (Windows) to Upload Files to Azure Blob Storage</a></li><li><a href=/docs/legacy/2023-09-20-powershell-automating-windows-crash-control-configuration/>PowerShell: Automating Windows Crash Control Configuration</a></li><li><a href=/docs/legacy/2023-09-18-powershell-create-a-nat-vmswitch-on-hyper-v/>PowerShell: Create a NAT VMSwitch on Hyper-V</a></li><li><a href=/docs/legacy/2023-09-18-powershell-download-iso-from-msdn-directly-to-the-server-vm/>PowerShell: Download ISO from MSDN Directly to the Server/VM</a></li><li><a href=/docs/legacy/2023-09-17-overview-of-shedevrum-yandexs-online-image-content-generation-service/>Overview of &amp;#8220;Shedevrum&amp;#8221;: Yandex&amp;#8217;s Online Image/Content Generation Service</a></li><li><a href=/docs/legacy/2023-09-16-hosting-a-custom-chatgpt-web-ui-with-your-own-api-keys/>Hosting a Custom ChatGPT Web UI with Your Own API Keys</a></li><li><a href=/docs/legacy/2023-09-13-powershell-gather-dns-server-logs-from-windows/>PowerShell: Gather DNS Server Logs from Windows</a></li><li><a href=/docs/legacy/2023-09-11-tracking-last-domain-login-events-on-azure-vms-a-handy-script/>Powershell: Tracking Last Domain Login Events on Azure VMs</a></li><li><a href=/docs/legacy/2023-09-10-how-hyper-v-works-high-level-overview/>How Hyper-V Works, High Level Overview</a></li><li><a href=/docs/legacy/2023-09-05-understanding-amsi-the-antimalware-scan-interface-in-windows-systems/>Understanding AMSI: The Antimalware Scan Interface in Windows Systems</a></li><li><a href=/docs/legacy/2023-08-28-how-to-track-registry-key-modifications-using-process-monitor/>How to Track Registry Key Modifications Using Process Monitor</a></li><li><a href=/docs/legacy/2023-08-27-bicep-execute-a-runcommand-on-already-running-azure-virtual-machine/>Bicep: Execute a RunCommand on already running Azure Virtual Machine</a></li><li><a href=/docs/legacy/2023-08-25-azure-nested-virtualization-hyper-v-cannot-be-installed-because-virtualization-support-is-not-enabled-in-the-bios/>Azure Nested Virtualization: Hyper-V cannot be installed because virtualization support is not enabled in the BIOS.</a></li><li><a href=/docs/legacy/2023-08-24-how-to-restart-group-policy-client-service-gpsvc/>How to restart Group Policy Client Service (GPSVC)</a></li><li><a href=/docs/legacy/2023-08-24-free-opnsense-firewall-nva-in-azure/>Free OPNsense Firewall NVA in Azure</a></li><li><a href=/docs/legacy/2023-08-23-youve-mounted-your-storage-account-but-you-see-that-the-space-available-is-less-than-visible-on-azure-portal/>You&amp;#8217;ve mounted your storage account, but you see that the space available is less than visible on Azure Portal</a></li><li><a href=/docs/legacy/2023-08-23-bicep-basic-windows-server-deployment-template-no-public-ip-no-nsg-deployment-in-existing-network/>Bicep: Basic Windows Server deployment template, no Public IP, no NSG, deployment in existing network.</a></li><li><a href=/docs/legacy/2023-08-23-bicep-deploy-virtual-machine-scale-set-and-put-it-behind-ilb-internal-load-balancer-as-backend-pool/ class=active>Bicep: Deploy Virtual Machine Scale Set and put it behind ILB (Internal Load Balancer) as backend pool</a></li><li><a href=/docs/legacy/2023-08-23-bicep-deploy-windows-server-vm-and-join-it-to-the-domain-using-the-password-dynamically-fetched-from-the-azure-keyvault/>Bicep: Deploy Windows Server VM and join it to the Domain using the password dynamically fetched from the Azure KeyVault</a></li><li><a href=/docs/legacy/2023-08-22-bicep-deploy-40-vms-at-once-with-cse-to-auto-configure-them/>Bicep: Deploy 40 VMs at once, with CSE to auto-configure them.</a></li><li><a href=/docs/legacy/2023-08-22-deploy-cse-custom-script-extension-using-managed-identity-to-authenticate-against-storage-account-where-script-is-stored-on-existing-running-vm/>Deploy CSE (Custom Script Extension) using Managed Identity to authenticate against storage account where script is stored on existing running VM</a></li><li><a href=/docs/legacy/2023-08-22-bicep-deploy-2-node-windows-failover-cluster-in-a-proximity-placement-group-ppg-with-3-shared-clustered-disks-and-cse-for-automatic-cluster-configuration/>Bicep: Deploy 2 Node Windows Failover Cluster, in a Proximity Placement Group (PPG), with 3 shared clustered disks and CSE for automatic cluster configuration</a></li><li><a href=/docs/legacy/2023-08-22-bicep-create-empty-managed-disk/>Bicep: Create empty Managed Disk</a></li><li><a href=/docs/legacy/2023-08-22-bicep-create-a-zrs-storage-account-with-a-random-storage-account-name/>Bicep: Create a ZRS Storage Account with a random Storage Account name</a></li><li><a href=/docs/legacy/2023-08-22-bicep-deploy-ubuntu-22-04-in-existing-vnet-subnet/>Bicep: Deploy Ubuntu 22.04 in existing VNET/Subnet</a></li><li><a href=/docs/legacy/2023-08-22-bicep-deploy-standalone-rhel8-4-and-vnet-subnet-with-public-ip-address-and-nsg-attached-to-it/>Bicep: Deploy Standalone RHEL8.4 and VNET/Subnet with Public IP address and NSG attached to it</a></li><li><a href=/docs/legacy/2023-08-22-bicep-deploy-centos-7-vm-in-existing-vnet-subnet/>Bicep: Deploy Centos 7 VM in existing VNET/Subnet</a></li><li><a href=/docs/legacy/2023-08-22-bicep-deploy-rhel-vm-in-existing-vnet-subnet-vm-with-plan-information/>Bicep: Deploy RHEL VM in existing VNET/Subnet (VM With Plan Information)</a></li><li><a href=/docs/legacy/2023-08-22-c-working-with-azure-imds/>C#: Working with Azure IMDS</a></li><li><a href=/docs/legacy/2023-08-22-c-check-if-service-exists-via-wmi/>C#: Check if service exists via WMI</a></li><li><a href=/docs/legacy/2023-08-22-powershell-send-telegram-message-via-bot-using-restapi-and-bot-token/>PowerShell: Send telegram message via Bot using RestAPI and Bot Token</a></li><li><a href=/docs/legacy/2023-08-22-powershell-restart-group-policy-client-service-can-be-used-as-run-command-on-azure-portal/>Powershell: Restart Group Policy Client Service (Can only be used as Run-Command on Azure Portal)</a></li><li><a href=/docs/legacy/2023-08-22-powershell-download-and-run-sysinternals-psping-to-test-network-connectivity-over-tcp/>PowerShell: Download and run Sysinternals PSPing to test network connectivity over TCP</a></li><li><a href=/docs/legacy/2023-08-22-powershell-perform-a-process-dump-of-a-windows-service-via-sysinternals-procdump-tool/>PowerShell: Perform a process dump of a windows service via Sysinternals procdump tool</a></li><li><a href=/docs/legacy/2023-08-22-powershell-check-azurevm-license-type-hybrid-benefit/>PowerShell: Check AzureVM license type (Hybrid Benefit)</a></li><li><a href=/docs/legacy/2023-08-22-powershell-check-if-accelerated-networking-adapter-is-present-within-windows-vm/>PowerShell: Check if Accelerated Networking Adapter is present within Windows VM</a></li><li><a href=/docs/legacy/2023-08-22-powershell-join-vm-to-the-domain/>Powershell: Join VM to the Domain</a></li><li><a href=/docs/legacy/2023-08-22-azure-cli-create-ipv6-enabled-vm/>Azure CLI: Create IPV6 enabled VM</a></li><li><a href=/docs/legacy/2023-08-22-capture-network-traffic-using-windows-built-in-tools/>Capture network traffic using windows built in tools</a></li><li><a href=/docs/legacy/2023-08-22-bicep-template-deploy-centos-7-5-in-existing-vnet-subnet-from-azure-marketplace-image/>Bicep Template: Deploy Centos 7.5 in existing VNET/Subnet from Azure MarketPlace Image</a></li><li class=book-section-flat><span>Shortcodes</span><ul><li><a href=/docs/shortcodes/buttons/>Buttons</a></li><li><a href=/docs/shortcodes/columns/>Columns</a></li><li><a href=/docs/shortcodes/details/>Details</a></li><li><a href=/docs/shortcodes/expand/>Expand</a></li><li><a href=/docs/shortcodes/hints/>Hints</a></li><li><a href=/docs/shortcodes/mermaid/>Mermaid</a></li><li><input type=checkbox id=section-d4c83c0dd655503a3da63d0c6550ed41 class=toggle>
<label for=section-d4c83c0dd655503a3da63d0c6550ed41 class="flex justify-between"><a href=/docs/shortcodes/section/>Section</a></label><ul><li><a href=/docs/shortcodes/section/first-page/>First Page</a></li><li><a href=/docs/shortcodes/section/second-page/>Second Page</a></li></ul></li><li><a href=/docs/shortcodes/tabs/>Tabs</a></li><li><a href=/docs/shortcodes/katex/>KaTeX</a></li></ul></li></ul><ul><li><a href=/posts/>Blog</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Bicep: Deploy Virtual Machine Scale Set and put it behind ILB (Internal Load Balancer) as backend pool</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents></nav></aside></header><article class="markdown book-article"><p>@description(&lsquo;Size of VMs in the VM Scale Set.&rsquo;)
param vmSku string = &lsquo;Standard_B2ms&rsquo;</p><p>@description(&lsquo;The Windows version for the VM. This will pick a fully patched image of this given Windows version. Allowed values: 2008-R2-SP1, 2012-Datacenter, 2012-R2-Datacenter & 2016-Datacenter, 2019-Datacenter.&rsquo;)
@allowed([
&lsquo;2008-R2-SP1&rsquo;
&lsquo;2012-Datacenter&rsquo;
&lsquo;2012-R2-Datacenter&rsquo;
&lsquo;2016-Datacenter&rsquo;
&lsquo;2019-Datacenter&rsquo;
])
param windowsOSVersion string = &lsquo;2019-Datacenter&rsquo;</p><p>@description(&lsquo;Number of VM instances (100 or less).&rsquo;)
@minValue(1)
@maxValue(100)
param instanceCount int = 3</p><p>@description(&lsquo;When true this limits the scale set to a single placement group, of max size 100 virtual machines. NOTE: If singlePlacementGroup is true, it may be modified to false. However, if singlePlacementGroup is false, it may not be modified to true.&rsquo;)
param singlePlacementGroup bool = true</p><p>@description(&lsquo;Admin username on all VMs.&rsquo;)
param adminUsername string = &lsquo;azureuser&rsquo;</p><p>@description(&lsquo;Admin password on all VMs.&rsquo;)
@minLength(12)
param adminPassword string</p><p>@description(&lsquo;Location for all resources.&rsquo;)
param location string = resourceGroup().location</p><p>@description(&lsquo;Fault Domain count for each placement group.&rsquo;)
param platformFaultDomainCount int = 1</p><p>param randomId string = substring(newGuid(), 0, 8)</p><p>var vmScaleSetName = toLower(vmssName)
var longvmScaleSet = &lsquo;${toLower(vmssName)}${randomId}&rsquo;
//var longvmScaleSet = toLower(vmssName)
var publicIPAddressName = &lsquo;${vmScaleSetName}pip&rsquo;
var loadBalancerName = &lsquo;${vmScaleSetName}lb&rsquo;
//var publicIPAddressID = publicIPAddress.id
var lbProbeID = resourceId(&lsquo;Microsoft.Network/loadBalancers/probes&rsquo;, loadBalancerName, &rsquo;tcpProbe&rsquo;)</p><p>var bePoolName = &lsquo;${vmScaleSetName}bepool&rsquo;
var lbPoolID = resourceId(&lsquo;Microsoft.Network/loadBalancers/backendAddressPools&rsquo;, loadBalancerName, bePoolName)</p><p>var nicName = &lsquo;${vmScaleSetName}nic&rsquo;
var ipConfigName = &lsquo;${vmScaleSetName}ipconfig&rsquo;
var frontEndIPConfigID = resourceId(&lsquo;Microsoft.Network/loadBalancers/frontendIPConfigurations&rsquo;, loadBalancerName, &rsquo;loadBalancerFrontEnd&rsquo;)
var osType = {
publisher: &lsquo;MicrosoftWindowsServer&rsquo;
offer: &lsquo;WindowsServer&rsquo;
sku: windowsOSVersion
version: &rsquo;latest&rsquo;
}
var imageReference = osType</p><p>@description(&lsquo;Your VNET name&rsquo;)
param vnetname string = &lsquo;EUN-Virtual-Network&rsquo;</p><p>@description(&lsquo;Your Subnet name&rsquo;)
param subnetname string = &lsquo;SD-WAN&rsquo;</p><p>@description(&lsquo;Your VNET RG name&rsquo;)
param vnetrg string = &lsquo;SD-WAN&rsquo;</p><p>@description(&lsquo;DNS Server 1&rsquo;)
param DNS1 string = &lsquo;192.168.1.210&rsquo;</p><p>resource loadBalancer &lsquo;Microsoft.Network/loadBalancers@2021-05-01&rsquo; = {
name: loadBalancerName
location: location
properties: {
frontendIPConfigurations: [
//Public IP
/* {
name: &lsquo;LoadBalancerFrontEnd&rsquo;
properties: {
publicIPAddress: {
id: publicIPAddressID
}
}
}
*/
// Private IP
{
name: &rsquo;loadBalancerFrontEnd&rsquo;
properties: {
privateIPAllocationMethod: &lsquo;Dynamic&rsquo;
subnet: {
id: subnet.id
}
}
}</p><pre><code>]
backendAddressPools: [
  {
    name: bePoolName
  }
]
loadBalancingRules: [
  {
    name: 'LBRule'
    properties: {
      frontendIPConfiguration: {
        id: frontEndIPConfigID
      }
      backendAddressPool: {
        id: lbPoolID
      }
      protocol: 'Tcp'
      frontendPort: 80
      backendPort: 80
      enableFloatingIP: false
      idleTimeoutInMinutes: 5
      probe: {
        id: lbProbeID
      }
    }
  }
]
probes: [
  {
    name: 'tcpProbe'
    properties: {
      protocol: 'Tcp'
      port: 80
      intervalInSeconds: 5
      numberOfProbes: 2
    }
  }
]
</code></pre><p>}
}</p><p>resource vmScaleSet &lsquo;Microsoft.Compute/virtualMachineScaleSets@2021-11-01&rsquo; = {
name: vmScaleSetName
location: location
dependsOn: [
loadBalancer
]
sku: {
name: vmSku
tier: &lsquo;Standard&rsquo;
capacity: instanceCount
}
properties: {
overprovision: true
upgradePolicy: {
automaticOSUpgradePolicy: {
enableAutomaticOSUpgrade: true
}
mode: &lsquo;Automatic&rsquo;
}
singlePlacementGroup: singlePlacementGroup
platformFaultDomainCount: platformFaultDomainCount
virtualMachineProfile: {
storageProfile: {
osDisk: {
caching: &lsquo;ReadWrite&rsquo;
createOption: &lsquo;FromImage&rsquo;
}
imageReference: imageReference
}
osProfile: {
computerNamePrefix: vmScaleSetName
adminUsername: adminUsername
adminPassword: adminPassword
windowsConfiguration: {
enableAutomaticUpdates: false
}
}
networkProfile: {
networkInterfaceConfigurations: [
{
name: nicName
properties: {
dnsSettings: {
dnsServers: [
DNS1
]
}
primary: true
ipConfigurations: [
{
name: ipConfigName
properties: {
subnet: {
id: ngfwvnet.properties.subnets[1].id
}
loadBalancerBackendAddressPools: [
{
id: lbPoolID
}
]
}
}
]
}
}
]
}
extensionProfile: {
extensions: [
{
name: &lsquo;confscaleset&rsquo;
properties: {
publisher: &lsquo;Microsoft.Compute&rsquo;
type: &lsquo;CustomScriptExtension&rsquo;
typeHandlerVersion: &lsquo;1.10&rsquo;
autoUpgradeMinorVersion: true
settings: {}
protectedSettings: {
commandToExecute: &lsquo;powershell -ExecutionPolicy Unrestricted -File EnableAnsibleWinRM.ps1&rsquo;
fileUris: [
&lsquo;https://test.test.local/yoursript.ps1&rsquo;
]
}
}
}
{
name: &lsquo;HealthExtension&rsquo;
properties:{
publisher: &lsquo;Microsoft.ManagedServices&rsquo;
type: &lsquo;ApplicationHealthWindows&rsquo;
typeHandlerVersion: &lsquo;1.0&rsquo;
autoUpgradeMinorVersion: true
settings: {
protocol: &lsquo;http&rsquo;
port: 80
requestPath: &lsquo;/&rsquo;
intervalInSeconds: 10
numberOfProbes: 2
}</p><pre><code>        }
      }
    ]
  }
}
</code></pre><p>}
}
/* Creation of Public IP
resource publicIPAddress &lsquo;Microsoft.Network/publicIPAddresses@2021-05-01&rsquo; = {
name: publicIPAddressName
location: location
properties: {
publicIPAllocationMethod: &lsquo;Static&rsquo;
dnsSettings: {
domainNameLabel: longvmScaleSet
}
}
}
*/
resource ngfwvnet &lsquo;Microsoft.Network/virtualnetworks@2021-02-01&rsquo; existing = {
name: vnetname
scope: resourceGroup(vnetrg)
}
resource subnet &lsquo;Microsoft.Network/virtualNetworks/subnets@2021-02-01&rsquo; existing = {
parent: ngfwvnet
name: subnetname
}</p><p>resource autoscalehost &lsquo;Microsoft.Insights/autoscalesettings@2021-05-01-preview&rsquo; = {
name: &lsquo;autoscalehost&rsquo;
location: location
properties: {
name: &lsquo;autoscalehost&rsquo;
targetResourceUri: vmScaleSet.id
enabled: true
profiles: [
{
name: &lsquo;Profile1&rsquo;
capacity: {
minimum: &lsquo;1&rsquo;
maximum: &lsquo;10&rsquo;
default: &lsquo;1&rsquo;
}
rules: [
{
metricTrigger: {
metricName: &lsquo;Percentage CPU&rsquo;
metricResourceUri: vmScaleSet.id
timeGrain: &lsquo;PT1M&rsquo;
statistic: &lsquo;Average&rsquo;
timeWindow: &lsquo;PT5M&rsquo;
timeAggregation: &lsquo;Average&rsquo;
operator: &lsquo;GreaterThan&rsquo;
threshold: 50
}
scaleAction: {
direction: &lsquo;Increase&rsquo;
type: &lsquo;ChangeCount&rsquo;
value: &lsquo;1&rsquo;
cooldown: &lsquo;PT5M&rsquo;
}
}
{
metricTrigger: {
metricName: &lsquo;Percentage CPU&rsquo;
metricResourceUri: vmScaleSet.id
timeGrain: &lsquo;PT1M&rsquo;
statistic: &lsquo;Average&rsquo;
timeWindow: &lsquo;PT5M&rsquo;
timeAggregation: &lsquo;Average&rsquo;
operator: &lsquo;LessThan&rsquo;
threshold: 30
}
scaleAction: {
direction: &lsquo;Decrease&rsquo;
type: &lsquo;ChangeCount&rsquo;
value: &lsquo;1&rsquo;
cooldown: &lsquo;PT5M&rsquo;
}
}
]
}
]
}
}</p><p>//output applicationUrl string = uri(&lsquo;http://${publicIPAddress.properties.dnsSettings.fqdn}&rsquo;, &lsquo;/MyApp&rsquo;)
" role=&ldquo;button&rdquo; style=&ldquo;color:#D4D4D4;display:none&rdquo; tabindex=&ldquo;0&rdquo;>```
@description(&lsquo;String used as a base for naming resources. Must be 3-61 characters in length and globally unique across Azure. A hash is prepended to this string for some resources, and resource-specific information is appended.&rsquo;)
@minLength(3)
@maxLength(61)
param vmssName string
@description(&lsquo;Size of VMs in the VM Scale Set.&rsquo;)
param vmSku string = &lsquo;Standard_B2ms&rsquo;
@description(&lsquo;The Windows version for the VM. This will pick a fully patched image of this given Windows version. Allowed values: 2008-R2-SP1, 2012-Datacenter, 2012-R2-Datacenter & 2016-Datacenter, 2019-Datacenter.&rsquo;)
@allowed([
&lsquo;2008-R2-SP1&rsquo;
&lsquo;2012-Datacenter&rsquo;
&lsquo;2012-R2-Datacenter&rsquo;
&lsquo;2016-Datacenter&rsquo;
&lsquo;2019-Datacenter&rsquo;
])
param windowsOSVersion string = &lsquo;2019-Datacenter&rsquo;
@description(&lsquo;Number of VM instances (100 or less).&rsquo;)
@minValue(1)
@maxValue(100)
param instanceCount int = 3
@description(&lsquo;When true this limits the scale set to a single placement group, of max size 100 virtual machines. NOTE: If singlePlacementGroup is true, it may be modified to false. However, if singlePlacementGroup is false, it may not be modified to true.&rsquo;)
param singlePlacementGroup bool = true
@description(&lsquo;Admin username on all VMs.&rsquo;)
param adminUsername string = &lsquo;azureuser&rsquo;
@description(&lsquo;Admin password on all VMs.&rsquo;)
@minLength(12)
param adminPassword string
@description(&lsquo;Location for all resources.&rsquo;)
param location string = resourceGroup().location
@description(&lsquo;Fault Domain count for each placement group.&rsquo;)
param platformFaultDomainCount int = 1
param randomId string = substring(newGuid(), 0, 8)
var vmScaleSetName = toLower(vmssName)
var longvmScaleSet = &rsquo;${toLower(vmssName)}${randomId}&rsquo;
//var longvmScaleSet = toLower(vmssName)
var publicIPAddressName = &rsquo;${vmScaleSetName}pip&rsquo;
var loadBalancerName = &rsquo;${vmScaleSetName}lb&rsquo;
//var publicIPAddressID = publicIPAddress.id
var lbProbeID = resourceId(&lsquo;Microsoft.Network/loadBalancers/probes&rsquo;, loadBalancerName, &lsquo;tcpProbe&rsquo;)
var bePoolName = &rsquo;${vmScaleSetName}bepool&rsquo;
var lbPoolID = resourceId(&lsquo;Microsoft.Network/loadBalancers/backendAddressPools&rsquo;, loadBalancerName, bePoolName)
var nicName = &rsquo;${vmScaleSetName}nic&rsquo;
var ipConfigName = &rsquo;${vmScaleSetName}ipconfig&rsquo;
var frontEndIPConfigID = resourceId(&lsquo;Microsoft.Network/loadBalancers/frontendIPConfigurations&rsquo;, loadBalancerName, &lsquo;loadBalancerFrontEnd&rsquo;)
var osType = {
publisher: &lsquo;MicrosoftWindowsServer&rsquo;
offer: &lsquo;WindowsServer&rsquo;
sku: windowsOSVersion
version: &lsquo;latest&rsquo;
}
var imageReference = osType
@description(&lsquo;Your VNET name&rsquo;)
param vnetname string = &lsquo;EUN-Virtual-Network&rsquo;
@description(&lsquo;Your Subnet name&rsquo;)
param subnetname string = &lsquo;SD-WAN&rsquo;
@description(&lsquo;Your VNET RG name&rsquo;)
param vnetrg string = &lsquo;SD-WAN&rsquo;
@description(&lsquo;DNS Server 1&rsquo;)
param DNS1 string = &lsquo;192.168.1.210&rsquo;
resource loadBalancer &lsquo;Microsoft.Network/loadBalancers@2021-05-01&rsquo; = {
name: loadBalancerName
location: location
properties: {
frontendIPConfigurations: [
//Public IP
/* {
name: &lsquo;LoadBalancerFrontEnd&rsquo;
properties: {
publicIPAddress: {
id: publicIPAddressID
}
}
}
<em>/ // Private IP
{
name: &lsquo;loadBalancerFrontEnd&rsquo;
properties: {
privateIPAllocationMethod: &lsquo;Dynamic&rsquo;
subnet: {
id: subnet.id
}
}
}
]
backendAddressPools: [
{
name: bePoolName
}
]
loadBalancingRules: [
{
name: &lsquo;LBRule&rsquo;
properties: {
frontendIPConfiguration: {
id: frontEndIPConfigID
}
backendAddressPool: {
id: lbPoolID
}
protocol: &lsquo;Tcp&rsquo;
frontendPort: 80
backendPort: 80
enableFloatingIP: false
idleTimeoutInMinutes: 5
probe: {
id: lbProbeID
}
}
}
]
probes: [
{
name: &lsquo;tcpProbe&rsquo;
properties: {
protocol: &lsquo;Tcp&rsquo;
port: 80
intervalInSeconds: 5
numberOfProbes: 2
}
}
]
}
}
resource vmScaleSet &lsquo;Microsoft.Compute/virtualMachineScaleSets@2021-11-01&rsquo; = {
name: vmScaleSetName
location: location
dependsOn: [
loadBalancer
]
sku: {
name: vmSku
tier: &lsquo;Standard&rsquo;
capacity: instanceCount
}
properties: {
overprovision: true
upgradePolicy: {
automaticOSUpgradePolicy: {
enableAutomaticOSUpgrade: true
}
mode: &lsquo;Automatic&rsquo;
}
singlePlacementGroup: singlePlacementGroup
platformFaultDomainCount: platformFaultDomainCount
virtualMachineProfile: {
storageProfile: {
osDisk: {
caching: &lsquo;ReadWrite&rsquo;
createOption: &lsquo;FromImage&rsquo;
}
imageReference: imageReference
}
osProfile: {
computerNamePrefix: vmScaleSetName
adminUsername: adminUsername
adminPassword: adminPassword
windowsConfiguration: {
enableAutomaticUpdates: false
}
}
networkProfile: {
networkInterfaceConfigurations: [
{
name: nicName
properties: {
dnsSettings: {
dnsServers: [
DNS1
]
}
primary: true
ipConfigurations: [
{
name: ipConfigName
properties: {
subnet: {
id: ngfwvnet.properties.subnets[1].id
}
loadBalancerBackendAddressPools: [
{
id: lbPoolID
}
]
}
}
]
}
}
]
}
extensionProfile: {
extensions: [
{
name: &lsquo;confscaleset&rsquo;
properties: {
publisher: &lsquo;Microsoft.Compute&rsquo;
type: &lsquo;CustomScriptExtension&rsquo;
typeHandlerVersion: &lsquo;1.10&rsquo;
autoUpgradeMinorVersion: true
settings: {}
protectedSettings: {
commandToExecute: &lsquo;powershell -ExecutionPolicy Unrestricted -File EnableAnsibleWinRM.ps1&rsquo;
fileUris: [
&lsquo;https://test.test.local/yoursript.ps1&rsquo;
]
}
}
}
{
name: &lsquo;HealthExtension&rsquo;
properties:{
publisher: &lsquo;Microsoft.ManagedServices&rsquo;
type: &lsquo;ApplicationHealthWindows&rsquo;
typeHandlerVersion: &lsquo;1.0&rsquo;
autoUpgradeMinorVersion: true
settings: {
protocol: &lsquo;http&rsquo;
port: 80
requestPath: &rsquo;/&rsquo;
intervalInSeconds: 10
numberOfProbes: 2
}
}
}
]
}
}
}
}
/</em> Creation of Public IP
resource publicIPAddress &lsquo;Microsoft.Network/publicIPAddresses@2021-05-01&rsquo; = {
name: publicIPAddressName
location: location
properties: {
publicIPAllocationMethod: &lsquo;Static&rsquo;
dnsSettings: {
domainNameLabel: longvmScaleSet
}
}
}
*/
resource ngfwvnet &lsquo;Microsoft.Network/virtualnetworks@2021-02-01&rsquo; existing = {
name: vnetname
scope: resourceGroup(vnetrg)
}
resource subnet &lsquo;Microsoft.Network/virtualNetworks/subnets@2021-02-01&rsquo; existing = {
parent: ngfwvnet
name: subnetname
}
resource autoscalehost &lsquo;Microsoft.Insights/autoscalesettings@2021-05-01-preview&rsquo; = {
name: &lsquo;autoscalehost&rsquo;
location: location
properties: {
name: &lsquo;autoscalehost&rsquo;
targetResourceUri: vmScaleSet.id
enabled: true
profiles: [
{
name: &lsquo;Profile1&rsquo;
capacity: {
minimum: &lsquo;1&rsquo;
maximum: &lsquo;10&rsquo;
default: &lsquo;1&rsquo;
}
rules: [
{
metricTrigger: {
metricName: &lsquo;Percentage CPU&rsquo;
metricResourceUri: vmScaleSet.id
timeGrain: &lsquo;PT1M&rsquo;
statistic: &lsquo;Average&rsquo;
timeWindow: &lsquo;PT5M&rsquo;
timeAggregation: &lsquo;Average&rsquo;
operator: &lsquo;GreaterThan&rsquo;
threshold: 50
}
scaleAction: {
direction: &lsquo;Increase&rsquo;
type: &lsquo;ChangeCount&rsquo;
value: &lsquo;1&rsquo;
cooldown: &lsquo;PT5M&rsquo;
}
}
{
metricTrigger: {
metricName: &lsquo;Percentage CPU&rsquo;
metricResourceUri: vmScaleSet.id
timeGrain: &lsquo;PT1M&rsquo;
statistic: &lsquo;Average&rsquo;
timeWindow: &lsquo;PT5M&rsquo;
timeAggregation: &lsquo;Average&rsquo;
operator: &lsquo;LessThan&rsquo;
threshold: 30
}
scaleAction: {
direction: &lsquo;Decrease&rsquo;
type: &lsquo;ChangeCount&rsquo;
value: &lsquo;1&rsquo;
cooldown: &lsquo;PT5M&rsquo;
}
}
]
}
]
}
}
//output applicationUrl string = uri(&lsquo;http://${publicIPAddress.properties.dnsSettings.fqdn}&rsquo;, &lsquo;/MyApp&rsquo;)</p><pre tabindex=0><code>
&lt;/div&gt;
</code></pre></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents></nav></div></aside></main></body></html>