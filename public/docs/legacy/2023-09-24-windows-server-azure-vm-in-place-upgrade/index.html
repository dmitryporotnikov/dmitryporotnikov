<!doctype html><html lang=en-us dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Upgrading your Windows Server Azure VM to a newer version can seem daunting, but with the right steps, it can be a smooth process. This guide will walk you through a step-by-step process, complete with visuals, to upgrade your Windows VM in Azure, for instance, from WS 2016 to 2019.
Prerequisites for a Successful Upgrade # Before diving into the upgrade, ensure the following prerequisites are met:
Managed Disk Usage"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="http://localhost:1313/docs/legacy/2023-09-24-windows-server-azure-vm-in-place-upgrade/"><meta property="og:site_name" content="My New Hugo Site"><meta property="og:title" content="In Place Upgrade Your Windows Server Azure VM: Step by Step Guide"><meta property="og:description" content="Upgrading your Windows Server Azure VM to a newer version can seem daunting, but with the right steps, it can be a smooth process. This guide will walk you through a step-by-step process, complete with visuals, to upgrade your Windows VM in Azure, for instance, from WS 2016 to 2019.
Prerequisites for a Successful Upgrade # Before diving into the upgrade, ensure the following prerequisites are met:
Managed Disk Usage"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2023-09-24T16:28:12+00:00"><meta property="article:modified_time" content="2023-09-24T16:28:12+00:00"><title>In Place Upgrade Your Windows Server Azure VM: Step by Step Guide | My New Hugo Site</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=canonical href=http://localhost:1313/docs/legacy/2023-09-24-windows-server-azure-vm-in-place-upgrade/><link rel=stylesheet href=/book.min.309b7ed028807cdb68d8d61e26d609f48369c098dbf5e4d8c0dcf4cdf49feafc.css integrity="sha256-MJt+0CiAfNto2NYeJtYJ9INpwJjb9eTYwNz0zfSf6vw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.d9141972cbd985809409a02b47b12ef5a7f171564a36bd0b25cc703c61d91f7b.js integrity="sha256-2RQZcsvZhYCUCaArR7Eu9afxcVZKNr0LJcxwPGHZH3s=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>My New Hugo Site</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li class=book-section-flat><a href=/docs/legacy/>Example Site</a><ul><li><a href=/docs/legacy/2024-06-10-azure-linux-vm-time-synchronization/>Setting Up Chrony for Time Synchronization in Azure VMs</a></li><li><a href=/docs/legacy/2024-04-23-resolving-argument-list-too-long-error-linux/>Resolving the "Argument list too long" Error When Deleting Files in Linux</a></li><li><a href=/docs/legacy/2024-03-28-automatic-os-upgrade-vmss-issue/>Automatic OS Upgrade is not supported for this Virtual Machine Scale Set because a health probe or health extension was not specified.</a></li><li><a href=/docs/legacy/2024-03-27-one-liner-to-add-new-privileged-user-to-azure-linux-vm-using-run-command/>One-liner to add new privileged user to Azure Linux VM using run command</a></li><li><a href=/docs/legacy/2024-03-21-tracing-cron-jobs/>Troubleshooting a Non-Working Linux Cron Job with Strace</a></li><li><a href=/docs/legacy/2024-03-17-revitalize-dell-latitude-e5570-arch-linux/>Adventures with Arch Linux on an Old Laptop - Dell Latitude E5570</a></li><li><a href=/docs/legacy/2024-02-11-windows-filtering-platform-wfp-overview/>Had some fun today learning about WFP drivers</a></li><li><a href=/docs/legacy/2024-02-09-kql-query-microsoft-services-retirement/>List services scheduled for retirement in Azure Graph / KQL</a></li><li><a href=/docs/legacy/2024-02-02-azure-vm-deployment-azure-ad-issue/>Encountering issues with Azure IAAS Virtual Machines not joining Azure AD post-deployment from a sysprepped template?</a></li><li><a href=/docs/legacy/2024-02-01-create-custom-filter-driver-windows/>How to Create Your Own Custom Filter Driver for Windows</a></li><li><a href=/docs/legacy/2024-01-30-install-windbg-windows-server-no-windows-store/>How to install WinDBG preview (Windows Store version) on Windows Server?</a></li><li><a href=/docs/legacy/2024-01-15-azzure-resource-graph-query-access/>Azure Resource Graph Queries to see who has access to Azure Subscriptions</a></li><li><a href=/docs/legacy/2023-12-01-recover-azure-vm-domain-admin-access/>PowerShell: Create a New Domain Admin User</a></li><li><a href=/docs/legacy/2023-11-07-enable-anonymous-access-azure-blob-storage/>Enabling Anonymous Access to Azure Blob Storage</a></li><li><a href=/docs/legacy/2023-11-06-manage-smb-1-windows/>Current configuration options for SMB 1.0 in Windows Environments</a></li><li><a href=/docs/legacy/2023-10-18-setting-up-a-flask-web-application-with-gunicorn-on-wsl/>Setting Up a Flask Web Application with Gunicorn on WSL</a></li><li><a href=/docs/legacy/2023-10-15-most-popular-operating-systems-desktop-laptops-1978-2023/>Most Popular Operating Systems (Desktop &amp;amp; Laptops) 1978 &amp;#8211; 2023</a></li><li><a href=/docs/legacy/2023-10-12-azure-vm-log-analysis-powershell/>PowerShell: Analyzing Virtual Machine Activity Logs to Determine Uptime and Downtime</a></li><li><a href=/docs/legacy/2023-10-11-thank-you-chatgpt/>Thank You, ChatGPT</a></li><li><a href=/docs/legacy/2023-10-11-nested-virtualization-madness-running-dosbox-inside-windows-xp-inside-windows-10-on-an-azure-vm-with-hyper-v/>Nested Virtualization Madness: Running DOSBox Inside Windows XP Inside Windows 10 on an Azure VM with Hyper-V</a></li><li><a href=/docs/legacy/2023-10-10-bypassing-azure-vm-limitations-script-based-solution/>PowerShell: Script-Based Workaround for Renaming Azure VMs and Switching to Unsupported Sizes</a></li><li><a href=/docs/legacy/2023-10-08-understanding-azure-capacity-reservations-guide/>Azure Capacity Reservations &amp;#038; Azure Reserved Instances</a></li><li><a href=/docs/legacy/2023-10-08-deploy-3-rhel-9_2-vms-with-shared-disks-to-form-a-cluster/>Bicep: Deploy 3 RHEL 9.2 VMs with shared disks to form a cluster</a></li><li><a href=/docs/legacy/2023-10-05-detecting-hypervisor-presence-using-cpuid-in-cpp/>C++: Detecting Hypervisor Presence Using CPUID Timing</a></li><li><a href=/docs/legacy/2023-10-03-linux-aio-performance-checker-real-time-diagnostics/>Streamlining Linux System Diagnostics: An Open-Source, Web-Based Approach</a></li><li><a href=/docs/legacy/2023-10-01-reverse-engineering-dotnet-applications-without-assembler/>Reverse Engineering .NET Applications Without Using Assembler</a></li><li><a href=/docs/legacy/2023-09-28-azure-rest-api-powershell-poc/>Rest API: Azure REST API POC</a></li><li><a href=/docs/legacy/2023-09-27-how-to-upgrade-legacy-azure-windows-vms/>How to Upgrade Legacy Azure Windows VMs Not Supported by Azure&amp;#8217;s Native In-Place Upgrade Feature</a></li><li><a href=/docs/legacy/2023-09-25-deploy-storage-spaces-on-azure-vm/>Deploy Storage Spaces on a Single Virtual Machine to Get Optimal Performance/Cost Ratio</a></li><li><a href=/docs/legacy/2023-09-24-windows-server-azure-vm-in-place-upgrade/ class=active>In Place Upgrade Your Windows Server Azure VM: Step by Step Guide</a></li><li><a href=/docs/legacy/2023-09-22-how-to-resolve-the-nla-error-in-azure-vms-when-the-computer-object-is-removed-from-active-directory/>How to resolve the NLA error in Azure VMs when the computer object is removed from Active Directory</a></li><li><a href=/docs/legacy/2023-09-22-simulating-memory-leaks-in-c-with-the-c-memory-leaker-tool-veryleakycauldron/>C++: Memory Leaker Tool &amp;#8211; VeryLeakyCauldron</a></li><li><a href=/docs/legacy/2023-09-21-why-cant-i-resize-the-underlying-storage-used-by-storage-spaces-direct/>Why can&amp;#8217;t I resize the underlying storage used by Storage Spaces?</a></li><li><a href=/docs/legacy/2023-09-20-powershell-download-and-use-azcopy-to-upload-files-to-azure-blob-storage/>PowerShell: Download and Use AzCopy (Windows) to Upload Files to Azure Blob Storage</a></li><li><a href=/docs/legacy/2023-09-20-powershell-automating-windows-crash-control-configuration/>PowerShell: Automating Windows Crash Control Configuration</a></li><li><a href=/docs/legacy/2023-09-18-powershell-create-a-nat-vmswitch-on-hyper-v/>PowerShell: Create a NAT VMSwitch on Hyper-V</a></li><li><a href=/docs/legacy/2023-09-18-powershell-download-iso-from-msdn-directly-to-the-server-vm/>PowerShell: Download ISO from MSDN Directly to the Server/VM</a></li><li><a href=/docs/legacy/2023-09-17-overview-of-shedevrum-yandexs-online-image-content-generation-service/>Overview of &amp;#8220;Shedevrum&amp;#8221;: Yandex&amp;#8217;s Online Image/Content Generation Service</a></li><li><a href=/docs/legacy/2023-09-16-hosting-a-custom-chatgpt-web-ui-with-your-own-api-keys/>Hosting a Custom ChatGPT Web UI with Your Own API Keys</a></li><li><a href=/docs/legacy/2023-09-13-powershell-gather-dns-server-logs-from-windows/>PowerShell: Gather DNS Server Logs from Windows</a></li><li><a href=/docs/legacy/2023-09-11-tracking-last-domain-login-events-on-azure-vms-a-handy-script/>Powershell: Tracking Last Domain Login Events on Azure VMs</a></li><li><a href=/docs/legacy/2023-09-10-how-hyper-v-works-high-level-overview/>How Hyper-V Works, High Level Overview</a></li><li><a href=/docs/legacy/2023-09-05-understanding-amsi-the-antimalware-scan-interface-in-windows-systems/>Understanding AMSI: The Antimalware Scan Interface in Windows Systems</a></li><li><a href=/docs/legacy/2023-08-28-how-to-track-registry-key-modifications-using-process-monitor/>How to Track Registry Key Modifications Using Process Monitor</a></li><li><a href=/docs/legacy/2023-08-27-bicep-execute-a-runcommand-on-already-running-azure-virtual-machine/>Bicep: Execute a RunCommand on already running Azure Virtual Machine</a></li><li><a href=/docs/legacy/2023-08-25-azure-nested-virtualization-hyper-v-cannot-be-installed-because-virtualization-support-is-not-enabled-in-the-bios/>Azure Nested Virtualization: Hyper-V cannot be installed because virtualization support is not enabled in the BIOS.</a></li><li><a href=/docs/legacy/2023-08-24-how-to-restart-group-policy-client-service-gpsvc/>How to restart Group Policy Client Service (GPSVC)</a></li><li><a href=/docs/legacy/2023-08-24-free-opnsense-firewall-nva-in-azure/>Free OPNsense Firewall NVA in Azure</a></li><li><a href=/docs/legacy/2023-08-23-youve-mounted-your-storage-account-but-you-see-that-the-space-available-is-less-than-visible-on-azure-portal/>You&amp;#8217;ve mounted your storage account, but you see that the space available is less than visible on Azure Portal</a></li><li><a href=/docs/legacy/2023-08-22-deploy-cse-custom-script-extension-using-managed-identity-to-authenticate-against-storage-account-where-script-is-stored-on-existing-running-vm/>Deploy CSE (Custom Script Extension) using Managed Identity to authenticate against storage account where script is stored on existing running VM</a></li><li><a href=/docs/legacy/2023-08-22-c-working-with-azure-imds/>C#: Working with Azure IMDS</a></li><li><a href=/docs/legacy/2023-08-22-c-check-if-service-exists-via-wmi/>C#: Check if service exists via WMI</a></li><li><a href=/docs/legacy/2023-08-22-capture-network-traffic-using-windows-built-in-tools/>Capture network traffic using windows built in tools</a></li></ul></li><li class=book-section-flat><a href=/docs/example/>Example Site</a><ul><li><a href=/docs/example/table-of-contents/>Table of Contents</a><ul><li><a href=/docs/example/table-of-contents/with-toc/>With ToC</a></li><li><a href=/docs/example/table-of-contents/without-toc/>Without ToC</a></li></ul></li><li><input type=checkbox id=section-3049b9efa63db187c30edc63a05cabc2 class=toggle>
<label for=section-3049b9efa63db187c30edc63a05cabc2 class="flex justify-between"><a role=button>Collapsed</a></label><ul><li><a href=/docs/example/collapsed/3rd-level/>3rd Level</a><ul><li><a href=/docs/example/collapsed/3rd-level/4th-level/>4th Level</a></li></ul></li></ul></li></ul></li><li class=book-section-flat><a href=/docs/example2/>Example Site</a><ul><li><a href=/docs/example2/table-of-contents/>Table of Contents</a><ul><li><a href=/docs/example2/table-of-contents/with-toc/>With ToC</a></li><li><a href=/docs/example2/table-of-contents/without-toc/>Without ToC</a></li></ul></li><li><input type=checkbox id=section-241c84bb3eab034a2a9fc6034c481dd5 class=toggle>
<label for=section-241c84bb3eab034a2a9fc6034c481dd5 class="flex justify-between"><a role=button>Collapsed</a></label><ul><li><a href=/docs/example2/collapsed/3rd-level/>3rd Level</a><ul><li><a href=/docs/example2/collapsed/3rd-level/4th-level/>4th Level</a></li></ul></li></ul></li></ul></li><li class=book-section-flat><span>Shortcodes</span><ul><li><a href=/docs/shortcodes/buttons/>Buttons</a></li><li><a href=/docs/shortcodes/columns/>Columns</a></li><li><a href=/docs/shortcodes/details/>Details</a></li><li><a href=/docs/shortcodes/expand/>Expand</a></li><li><a href=/docs/shortcodes/hints/>Hints</a></li><li><a href=/docs/shortcodes/mermaid/>Mermaid</a></li><li><input type=checkbox id=section-d4c83c0dd655503a3da63d0c6550ed41 class=toggle>
<label for=section-d4c83c0dd655503a3da63d0c6550ed41 class="flex justify-between"><a href=/docs/shortcodes/section/>Section</a></label><ul><li><a href=/docs/shortcodes/section/first-page/>First Page</a></li><li><a href=/docs/shortcodes/section/second-page/>Second Page</a></li></ul></li><li><a href=/docs/shortcodes/tabs/>Tabs</a></li><li><a href=/docs/shortcodes/katex/>KaTeX</a></li></ul></li></ul><ul><li><a href=/posts/>Blog</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>In Place Upgrade Your Windows Server Azure VM: Step by Step Guide</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#span-classez-toc-section-idprerequisites_for_a_successful_upgradespanprerequisites-for-a-successful-upgradespan-classez-toc-section-endspan><strong>Prerequisites for a Successful Upgrade</strong></a></li></ul></nav></aside></header><article class="markdown book-article"><p>Upgrading your Windows Server Azure VM to a newer version can seem daunting, but with the right steps, it can be a smooth process. This guide will walk you through a step-by-step process, complete with visuals, to upgrade your Windows VM in Azure, for instance, from WS 2016 to 2019.</p><h2 id=span-classez-toc-section-idprerequisites_for_a_successful_upgradespanprerequisites-for-a-successful-upgradespan-classez-toc-section-endspan><strong>Prerequisites for a Successful Upgrade</strong>
<a class=anchor href=#span-classez-toc-section-idprerequisites_for_a_successful_upgradespanprerequisites-for-a-successful-upgradespan-classez-toc-section-endspan>#</a></h2><p>Before diving into the upgrade, ensure the following prerequisites are met:</p><p><strong>Managed Disk Usage</strong><br>Your VM should be using a managed disk. You can verify this via the Azure portal in the JSON view. If your VM isn’t using a managed disk, you can migrate to one.</p><ul><li>Within the VM, run the command: <code>slmgr/dlv</code></li><li>The description should display: <code>VOLUME_KMSCLIENT channel</code></li></ul><p><strong>Snapshot Precaution</strong><br>Before proceeding with the upgrade, take a snapshot of the OS drive. This acts as a safety net, allowing you to roll back if anything goes south.</p><p>Since Azure doesn’t provide access to the Virtual Machine ISO mounting feature at the hypervisor level, you’ll need to create a managed disk with the upgrade media. Use the following script, sourced from <a href=https://learn.microsoft.com/en-us/azure/virtual-machines/windows-in-place-upgrade>Microsoft’s official documentation</a>:</p><h1 id=set-the-subscription-context>Set the subscription context
<a class=anchor href=#set-the-subscription-context>#</a></h1><p>$subscriptionId = &ldquo;YOUR SUB ID&rdquo;
Set-AzContext -SubscriptionId $subscriptionId</p><h1 id=resource-group-of-the-source-vm>Resource group of the source VM
<a class=anchor href=#resource-group-of-the-source-vm>#</a></h1><p>$resourceGroup = &ldquo;LETSUPGRADE&rdquo;</p><h1 id=location-of-the-source-vm>Location of the source VM
<a class=anchor href=#location-of-the-source-vm>#</a></h1><p>$location = &ldquo;North Europe&rdquo;</p><h1 id=zone-of-the-source-vm-if-any>Zone of the source VM, if any
<a class=anchor href=#zone-of-the-source-vm-if-any>#</a></h1><p>$zone = ""</p><h1 id=disk-name-for-the-that-will-be-created>Disk name for the that will be created
<a class=anchor href=#disk-name-for-the-that-will-be-created>#</a></h1><p>$diskName = &ldquo;WindowsServer2022UpgradeDisk&rdquo;</p><h1 id=target-version-for-the-upgrade---must-be-either-server2022upgrade-or-server2019upgrade>Target version for the upgrade - must be either server2022Upgrade or server2019Upgrade
<a class=anchor href=#target-version-for-the-upgrade---must-be-either-server2022upgrade-or-server2019upgrade>#</a></h1><p>$sku = &ldquo;server2022Upgrade&rdquo;</p><h1 id=common-parameters>Common parameters
<a class=anchor href=#common-parameters>#</a></h1><p>$publisher = &ldquo;MicrosoftWindowsServer&rdquo;
$offer = &ldquo;WindowsServerUpgrade&rdquo;
$managedDiskSKU = &ldquo;Standard_LRS&rdquo;</p><h1 id=get-the-latest-version-of-the-special-hidden-vm-image-from-the-azure-marketplace>Get the latest version of the special (hidden) VM Image from the Azure Marketplace
<a class=anchor href=#get-the-latest-version-of-the-special-hidden-vm-image-from-the-azure-marketplace>#</a></h1><p>$versions = Get-AzVMImage -PublisherName $publisher -Location $location -Offer $offer -Skus $sku | sort-object -Descending {[version] $_.Version }
$latestString = $versions[0].Version</p><h1 id=get-the-special-hidden-vm-image-from-the-azure-marketplace-by-version---the-image-is-used-to-create-a-disk-to-upgrade-to-the-new-version>Get the special (hidden) VM Image from the Azure Marketplace by version - the image is used to create a disk to upgrade to the new version
<a class=anchor href=#get-the-special-hidden-vm-image-from-the-azure-marketplace-by-version---the-image-is-used-to-create-a-disk-to-upgrade-to-the-new-version>#</a></h1><p>$image = Get-AzVMImage -Location $location <code>-PublisherName $publisher</code>
-Offer $offer <code>-Skus $sku</code>
-Version $latestString</p><h1 id=heading><a class=anchor href=#heading>#</a></h1><h1 id=create-resource-group-if-it-doesnt-exist>Create Resource Group if it doesn&rsquo;t exist
<a class=anchor href=#create-resource-group-if-it-doesnt-exist>#</a></h1><h1 id=heading-1><a class=anchor href=#heading-1>#</a></h1><p>if (-not (Get-AzResourceGroup -Name $resourceGroup -ErrorAction SilentlyContinue)) {
New-AzResourceGroup -Name $resourceGroup -Location $location<br>}</p><h1 id=heading-2><a class=anchor href=#heading-2>#</a></h1><h1 id=create-managed-disk-from-lun-0>Create Managed Disk from LUN 0
<a class=anchor href=#create-managed-disk-from-lun-0>#</a></h1><h1 id=heading-3><a class=anchor href=#heading-3>#</a></h1><p>if ($zone){
$diskConfig = New-AzDiskConfig -SkuName $managedDiskSKU <code>-CreateOption FromImage</code>
-Zone $zone <code>-Location $location } else { $diskConfig = New-AzDiskConfig -SkuName $managedDiskSKU</code>
-CreateOption FromImage <code>-Location $location } Set-AzDiskImageReference -Disk $diskConfig -Id $image.Id -Lun 0 New-AzDisk -ResourceGroupName $resourceGroup</code>
-DiskName $diskName <code>-Disk $diskConfig" role="button" style="color:#D4D4D4;display:none" tabindex="0">&lt;svg fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">&lt;path class="with-check" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-linecap="round" stroke-linejoin="round">&lt;/path>&lt;path class="without-check" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-linecap="round" stroke-linejoin="round">&lt;/path>&lt;/svg>&lt;/span>``` &lt;span class="line">&lt;span style="color: #6A9955"># Login to Azure&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #DCDCAA">Connect-AzAccount&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Set the subscription context&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$subscriptionId&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #CE9178">"YOUR SUB ID"&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #DCDCAA">Set-AzContext&lt;/span>&lt;span style="color: #D4D4D4"> -SubscriptionId &lt;/span>&lt;span style="color: #9CDCFE">$subscriptionId&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Resource group of the source VM&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$resourceGroup&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #CE9178">"LETSUPGRADE"&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Location of the source VM&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$location&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #CE9178">"North Europe"&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Zone of the source VM, if any&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$zone&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #CE9178">""&lt;/span>&lt;span style="color: #D4D4D4"> &lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Disk name for the that will be created&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$diskName&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #CE9178">"WindowsServer2022UpgradeDisk"&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Target version for the upgrade - must be either server2022Upgrade or server2019Upgrade&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$sku&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #CE9178">"server2022Upgrade"&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Common parameters&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$publisher&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #CE9178">"MicrosoftWindowsServer"&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$offer&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #CE9178">"WindowsServerUpgrade"&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$managedDiskSKU&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #CE9178">"Standard_LRS"&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Get the latest version of the special (hidden) VM Image from the Azure Marketplace&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$versions&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #DCDCAA">Get-AzVMImage&lt;/span>&lt;span style="color: #D4D4D4"> -PublisherName &lt;/span>&lt;span style="color: #9CDCFE">$publisher&lt;/span>&lt;span style="color: #D4D4D4"> -Location &lt;/span>&lt;span style="color: #9CDCFE">$location&lt;/span>&lt;span style="color: #D4D4D4"> -Offer &lt;/span>&lt;span style="color: #9CDCFE">$offer&lt;/span>&lt;span style="color: #D4D4D4"> -Skus &lt;/span>&lt;span style="color: #9CDCFE">$sku&lt;/span>&lt;span style="color: #D4D4D4"> | &lt;/span>&lt;span style="color: #DCDCAA">sort-object&lt;/span>&lt;span style="color: #D4D4D4"> -Descending {[&lt;/span>&lt;span style="color: #569CD6">version&lt;/span>&lt;span style="color: #D4D4D4">] &lt;/span>&lt;span style="color: #9CDCFE">$_&lt;/span>&lt;span style="color: #DCDCAA">.Version&lt;/span>&lt;span style="color: #D4D4D4"> }&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$latestString&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #9CDCFE">$versions&lt;/span>&lt;span style="color: #D4D4D4">[&lt;/span>&lt;span style="color: #B5CEA8">0&lt;/span>&lt;span style="color: #D4D4D4">].Version&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Get the special (hidden) VM Image from the Azure Marketplace by version - the image is used to create a disk to upgrade to the new version&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #9CDCFE">$image&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #DCDCAA">Get-AzVMImage&lt;/span>&lt;span style="color: #D4D4D4"> -Location &lt;/span>&lt;span style="color: #9CDCFE">$location&lt;/span>&lt;span style="color: #D4D4D4"></code>
-PublisherName $publisher <code>&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #D4D4D4"> -Offer &lt;/span>&lt;span style="color: #9CDCFE">$offer&lt;/span>&lt;span style="color: #D4D4D4"> </code>-Skus $sku <code>&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #D4D4D4"> -Version &lt;/span>&lt;span style="color: #9CDCFE">$latestString&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955">#&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Create Resource Group if it doesn't exist&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955">#&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #C586C0">if&lt;/span>&lt;span style="color: #D4D4D4"> (-not (&lt;/span>&lt;span style="color: #DCDCAA">Get-AzResourceGroup&lt;/span>&lt;span style="color: #D4D4D4"> -Name &lt;/span>&lt;span style="color: #9CDCFE">$resourceGroup&lt;/span>&lt;span style="color: #D4D4D4"> -ErrorAction SilentlyContinue)) {&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #D4D4D4"> &lt;/span>&lt;span style="color: #DCDCAA">New-AzResourceGroup&lt;/span>&lt;span style="color: #D4D4D4"> -Name &lt;/span>&lt;span style="color: #9CDCFE">$resourceGroup&lt;/span>&lt;span style="color: #D4D4D4"> -Location &lt;/span>&lt;span style="color: #9CDCFE">$location&lt;/span>&lt;span style="color: #D4D4D4"> &lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #D4D4D4">}&lt;/span>&lt;/span> &lt;span class="line">&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955">#&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955"># Create Managed Disk from LUN 0&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #6A9955">#&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #C586C0">if&lt;/span>&lt;span style="color: #D4D4D4"> (&lt;/span>&lt;span style="color: #9CDCFE">$zone&lt;/span>&lt;span style="color: #D4D4D4">){&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #D4D4D4"> &lt;/span>&lt;span style="color: #9CDCFE">$diskConfig&lt;/span>&lt;span style="color: #D4D4D4"> = &lt;/span>&lt;span style="color: #DCDCAA">New-AzDiskConfig&lt;/span>&lt;span style="color: #D4D4D4"> -SkuName &lt;/span>&lt;span style="color: #9CDCFE">$managedDiskSKU&lt;/span>&lt;span style="color: #D4D4D4"> </code>-CreateOption FromImage <code>&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #D4D4D4"> -Zone &lt;/span>&lt;span style="color: #9CDCFE">$zone&lt;/span>&lt;span style="color: #D4D4D4"> </code>-Location $location
} else {
$diskConfig = New-AzDiskConfig -SkuName $managedDiskSKU <code>&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #D4D4D4"> -CreateOption FromImage </code>-Location $location
} Set-AzDiskImageReference -Disk $diskConfig -Id $image.Id -Lun 0
New-AzDisk -ResourceGroupName $resourceGroup <code>&lt;/span>&lt;/span> &lt;span class="line">&lt;span style="color: #D4D4D4"> -DiskName &lt;/span>&lt;span style="color: #9CDCFE">$diskName&lt;/span>&lt;span style="color: #D4D4D4"> </code>-Disk $diskConfig</p><pre tabindex=0><code>
&lt;/div&gt;After running the script, you should see the disk created in the resource group you specified:

&lt;figure class=&#34;wp-block-image size-full is-resized&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235628/image-4.png)&lt;/figure&gt;Attach the upgrade disk to the virtual machine. If you’re unable to view the drive you’re trying to attach, consider clicking “Refresh” button on the Disks view:

&lt;figure class=&#34;wp-block-image size-large is-resized&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235623/image-5-1024x586.png)&lt;/figure&gt;Connect to the VM using RDP. You should now see the upgrade disk in the file explorer.

&lt;figure class=&#34;wp-block-image size-full&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235621/image-6.png)&lt;/figure&gt;Run the installer with the following parameters, as recommended by Microsoft: `.\setup.exe /auto upgrade /dynamicupdate disable`

&lt;figure class=&#34;wp-block-image size-full&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235620/image-7.png)&lt;/figure&gt;Follow the installer prompts and wait for your system to transition to install mode. This is a good time to take a break or start the installation on another server.

&lt;figure class=&#34;wp-block-image size-large&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235619/image-8-1024x433.png)&lt;/figure&gt;&lt;figure class=&#34;wp-block-image size-full&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235618/image-9.png)&lt;/figure&gt;After the RDP session disconnects, monitor the installation progress using Azure boot diagnostics.

&lt;figure class=&#34;wp-block-image size-full&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235616/image-10.png)&lt;/figure&gt;Once the boot diagnostic displays the login screen:

&lt;figure class=&#34;wp-block-image size-full&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235615/image-11.jpg)&lt;/figure&gt;  
Reconnect via RDP and confirm the upgrade’s success by running the `winver` command.

## &lt;span class=&#34;ez-toc-section&#34; id=&#34;Post-Upgrade_Cleanup&#34;&gt;&lt;/span&gt;**Post-Upgrade Cleanup**&lt;span class=&#34;ez-toc-section-end&#34;&gt;&lt;/span&gt;

**Disk Cleanup**  
Use the disk cleanup utility to remove the `windows.old` folder located in the root of your C:\\ drive.

&lt;figure class=&#34;wp-block-image size-full&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235614/image-11.png)&lt;/figure&gt;**Upgrade Media**  
Detach the upgrade media and delete the managed disk you created with the script.

**Snapshot**  
Now that your upgrade is complete and verified, you can delete the OS disk snapshot you created earlier.

## &lt;span class=&#34;ez-toc-section&#34; id=&#34;A_Note_on_Image_Plan&#34;&gt;&lt;/span&gt;**A Note on Image Plan**&lt;span class=&#34;ez-toc-section-end&#34;&gt;&lt;/span&gt;

Post-upgrade, you might notice that your Image Plan in the Azure Portal remains unchanged. This is purely cosmetic and reflects the image from which the VM was originally deployed.

&lt;figure class=&#34;wp-block-image size-full&#34;&gt;![](https://cdn.porotnikov.com/media/2023/09/24235613/image-12.png)&lt;/figure&gt;As you see upgrading the Windows Server Azure VM in place is pretty straightforward process. By following the steps outlined in this guide, you can safely and easily upgrade your VM to a new version. And if you encounter any problems with the upgrade, you can always restore your VM from the snapshot you created before starting the upgrade. You’ve created the snapshot, right? 😉
</code></pre></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#span-classez-toc-section-idprerequisites_for_a_successful_upgradespanprerequisites-for-a-successful-upgradespan-classez-toc-section-endspan><strong>Prerequisites for a Successful Upgrade</strong></a></li></ul></nav></div></aside></main></body></html>